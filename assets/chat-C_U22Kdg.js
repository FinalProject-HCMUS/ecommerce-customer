import{j as e,r,u as A}from"./index-CxKmREMg.js";import{B as I}from"./Breadcrumb-i6hEoVxp.js";import{d as L,a as v}from"./App-ml3lkzHZ.js";import{c as w}from"./request-BhcxZV3V.js";import{L as N}from"./Loading-DTzowA59.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const P=L("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]),R=()=>e.jsxs("div",{className:"flex space-x-1",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-bounce",style:{animationDelay:"300ms"}})]}),z=({message:s})=>e.jsxs("div",{className:`flex items-start gap-3 ${s.sender==="other"?"justify-end":""}`,children:[s.sender==="user"&&e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-300",children:e.jsx("img",{src:"/placeholder.svg?height=40&width=40",alt:"User avatar",className:"w-full h-full object-cover"})}),e.jsxs("div",{className:`group max-w-[80%] sm:max-w-[70%] ${s.sender==="other"?"order-1":"order-2"}`,children:[s.isTyping?e.jsx("div",{className:"bg-gray-200 rounded-3xl py-3 px-4 inline-block",children:e.jsx(R,{})}):e.jsx("div",{className:`rounded-3xl py-3 px-4 animate-fade-in ${s.sender==="user"?"bg-black text-white":"bg-gray-800 text-white"}`,children:s.text}),s.timestamp&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:s.timestamp})]}),s.sender==="other"&&e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-300 order-2",children:e.jsx("img",{src:"/placeholder.svg?height=40&width=40",alt:"Other user avatar",className:"w-full h-full object-cover"})})]}),S=r.forwardRef(({messages:s,messagesEndRef:a})=>e.jsx("div",{className:"max-w-4xl mx-auto space-y-6 p-4",children:s.length===0?e.jsx("div",{className:"text-center text-gray-500 py-8",children:"No messages yet. Start the conversation!"}):e.jsxs(e.Fragment,{children:[s.map(n=>e.jsx(z,{message:n},n.id)),e.jsx("div",{ref:a})]})}));S.displayName="ChatContainer";const D=({onSendMessage:s})=>{const[a,n]=r.useState(""),l=t=>{t.preventDefault(),a.trim()&&(s(a),n(""))};return e.jsx("div",{className:"bg-white border-t p-4",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("form",{onSubmit:l,className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx("input",{type:"text",value:a,onChange:t=>n(t.target.value),placeholder:"Type something",className:"w-full py-3 px-4 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-200"}),e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsx("button",{type:"submit",className:"p-2 rounded-full bg-gray-800 text-white",disabled:!a.trim(),children:e.jsx(P,{className:"h-5 w-5"})})})]}),e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden flex-shrink-0 bg-gray-300",children:e.jsx("img",{src:"/placeholder.svg?height=40&width=40",alt:"Your avatar",className:"w-full h-full object-cover"})})]})})})},B=async s=>(await w.get(`/conversations/customer/${s}`)).data,$=()=>{const[s,a]=r.useState({conversations:[],loading:!1}),n=async l=>{a(t=>({...t,loading:!0,error:null}));try{const t=await B(l);t.isSuccess&&t.data&&a({conversations:t.data,loading:!1})}finally{a(t=>({...t,loading:!1}))}};return{conversations:s.conversations,loading:s.loading,fetchCustomerConversations:n}},U=async(s,a=0,n=10,l)=>{const t=new URLSearchParams;return t.append("page",a.toString()),t.append("size",n.toString()),l&&l.length&&l.forEach(d=>t.append("sort",d)),(await w.get(`/messages/conversation/${s}/paginated?${t.toString()}`)).data},O=()=>{const[s,a]=r.useState({messages:[],loading:!1,pagination:{page:0,size:10,totalPages:0,totalElements:0}}),n=r.useCallback(async(c,d=0,u=10,x=["createdAt,asc"])=>{var g,p;if(!c){a(o=>({...o,error:"Conversation ID is required"}));return}a(o=>({...o,loading:!0,error:null}));try{const o=await U(c,d,u,x);o.isSuccess&&o.data?a({messages:o.data.content,loading:!1,pagination:{page:((g=o.data.pageable)==null?void 0:g.pageNumber)||d,size:((p=o.data.pageable)==null?void 0:p.pageSize)||u,totalPages:o.data.totalPages||0,totalElements:o.data.totalElements||0}}):a(m=>({...m,loading:!1}))}catch(o){const m=o instanceof Error?o.message:"An unexpected error occurred";a(f=>({...f,loading:!1,error:m}))}},[]),l=r.useCallback((c,d,u)=>{n(c,d,s.pagination.size,u)},[n,s.pagination.size]),t=r.useCallback((c,d,u)=>{n(c,0,d,u)},[n]);return{messages:s.messages,loading:s.loading,pagination:s.pagination,fetchMessages:n,changePage:l,changePageSize:t}};var C=(s=>(s.ADMIN="ADMIN",s.CUSTOMER="CUSTOMER",s))(C||{});const G=()=>{const{userInfo:s}=A(i=>i.auth),a=r.useRef(null),n=r.useRef(null),[l,t]=r.useState(null),[c,d]=r.useState(!0),[u,x]=r.useState(!0),{conversations:g,loading:p,fetchCustomerConversations:o}=$(),{messages:m,loading:f,pagination:h,fetchMessages:b,changePage:M}=O();r.useEffect(()=>{s!=null&&s.id&&o(s.id)},[s==null?void 0:s.id]),r.useEffect(()=>{(g==null?void 0:g.length)>0&&!l&&t(g[0].id)},[g]),r.useEffect(()=>{l&&(b(l,0,20,["createdAt,desc"]),x(!0))},[l]),r.useEffect(()=>{m.length&&u&&(j(),x(!1))},[m,u]),r.useEffect(()=>{d(h.page<h.totalPages-1)},[h]);const y=r.useCallback(()=>{const i=n.current;!i||f||!c||i.scrollTop<100&&M(l,h.page+1,["createdAt,desc"])},[l,f,h.page,c]);r.useEffect(()=>{const i=n.current;if(i)return i.addEventListener("scroll",y),()=>{i.removeEventListener("scroll",y)}},[y]);const j=()=>{var i;(i=a.current)==null||i.scrollIntoView({behavior:"smooth"})},E=async i=>{if(!(!i.trim()||!l||!(s!=null&&s.id)))try{b(l,0,h.size,["createdAt,desc"]),setTimeout(j,100)}catch(T){console.error("Failed to send message:",T)}},k=[...m].reverse();return e.jsxs("div",{className:"flex mt-10 px-8 py-8 flex-col h-screen bg-gray-50 bg-white text-gray-800",children:[e.jsx(I,{items:[{label:v("breadcrumb.home"),path:"/"},{label:v("breadcrumb.chat"),path:"/chat"}]}),p&&!g.length?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(N,{})}):g.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:v("msg.noConversations")}),e.jsx("p",{className:"text-gray-500",children:v("msg.startNewConversation")})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:n,className:"flex-1 overflow-y-auto relative",children:[f&&h.page>0&&e.jsx("div",{className:"sticky top-0 w-full bg-gray-100 p-2 text-center",children:e.jsx(N,{})}),e.jsx(S,{messages:k.map(i=>({id:i.id,text:i.content,sender:i.roleChat===C.CUSTOMER?"user":"other",timestamp:new Date(i.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})),messagesEndRef:a})]}),e.jsx(D,{onSendMessage:E})]})]})};export{G as default};
